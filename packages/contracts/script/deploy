#!/bin/bash

# Portfolio Rebalancer Multi-Network Deployment with Verification
# 
# Prerequisites:
# 1. Set up .env file with API keys for your target networks:
#    # Ethereum networks
#    ETHERSCAN_API_KEY=your_etherscan_key_here
#    MAINNET_RPC_URL=your_mainnet_rpc_url
#    SEPOLIA_RPC_URL=your_sepolia_rpc_url
#    
#    # Base networks  
#    BASESCAN_API_KEY=your_basescan_key_here
#    BASE_RPC_URL=your_base_rpc_url
#    BASE_SEPOLIA_RPC_URL=your_base_sepolia_rpc_url
#    
#    # Deployer key
#    PRIVATE_KEY=your_private_key_here
#
# 2. Fund your deployer account with native tokens for the target network
#
# Usage: sh deploy --network {network_name}
# Supported networks: sepolia, mainnet, base, baseSepolia

set -e  # Exit on any error

# Load environment variables from .env file
if [ -f ".env" ]; then
    echo "Loading environment variables from .env file..."
    export $(cat .env | grep -v '^#' | xargs)
else
    echo "Warning: .env file not found. Make sure environment variables are set manually."
fi

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to get network configuration
get_network_config() {
    local network=$1
    case $network in
        sepolia)
            echo "SEPOLIA_RPC_URL 11155111 ETHERSCAN_API_KEY Sepolia"
            ;;
        mainnet)
            echo "MAINNET_RPC_URL 1 ETHERSCAN_API_KEY Ethereum_Mainnet"
            ;;
        base)
            echo "BASE_RPC_URL 8453 BASESCAN_API_KEY Base_Mainnet"
            ;;
        baseSepolia)
            echo "BASE_SEPOLIA_RPC_URL 84532 BASESCAN_API_KEY Base_Sepolia"
            ;;
        *)
            echo ""
            ;;
    esac
}

# Function to show usage
show_usage() {
    echo -e "${BLUE}Usage: sh deploy --network {network_name}${NC}"
    echo ""
    echo "Supported networks:"
    echo "  sepolia      - Ethereum Sepolia testnet"
    echo "  mainnet      - Ethereum mainnet"
    echo "  base         - Base mainnet"
    echo "  baseSepolia  - Base Sepolia testnet"
    echo ""
    echo "Example: sh deploy --network sepolia"
}

# Parse command line arguments
NETWORK=""
while [ $# -gt 0 ]; do
    case $1 in
        --network)
            NETWORK="$2"
            shift 2
            ;;
        -h|--help)
            show_usage
            exit 0
            ;;
        *)
            echo -e "${RED}ERROR: Unknown argument: $1${NC}"
            show_usage
            exit 1
            ;;
    esac
done

# Validate network parameter
if [ -z "$NETWORK" ]; then
    echo -e "${RED}ERROR: Network not specified${NC}"
    echo ""
    show_usage
    exit 1
fi

# Get network configuration
NETWORK_CONFIG=$(get_network_config "$NETWORK")
if [ -z "$NETWORK_CONFIG" ]; then
    echo -e "${RED}ERROR: Unsupported network: $NETWORK${NC}"
    echo ""
    show_usage
    exit 1
fi

# Parse network configuration
set -- $NETWORK_CONFIG
RPC_URL_VAR=$1
CHAIN_ID=$2
API_KEY_VAR=$3
DISPLAY_NAME=$4

echo -e "${GREEN}=== Portfolio Rebalancer Deployment with Verification ===${NC}"
echo -e "${BLUE}Target Network: $DISPLAY_NAME (Chain ID: $CHAIN_ID)${NC}"
echo ""

# Check if .env file exists (in contracts root directory)
if [ ! -f .env ]; then
    echo -e "${RED}ERROR: .env file not found${NC}"
    echo "Create .env file in the contracts root directory with required variables for $DISPLAY_NAME:"
    echo "PRIVATE_KEY=your_private_key_here"
    echo "${RPC_URL_VAR}=your_rpc_url_here"
    echo "${API_KEY_VAR}=your_api_key_here"
    exit 1
fi

# Source environment variables
. .env

# Check required environment variables
if [ -z "$PRIVATE_KEY" ]; then
    echo -e "${RED}ERROR: PRIVATE_KEY not set in .env${NC}"
    exit 1
fi

# Get RPC URL from environment variable
eval "RPC_URL=\$${RPC_URL_VAR}"
if [ -z "$RPC_URL" ]; then
    echo -e "${RED}ERROR: $RPC_URL_VAR not set in .env${NC}"
    echo "Please add: $RPC_URL_VAR=your_rpc_url_here"
    exit 1
fi

# Get API key from environment variable
eval "API_KEY=\$${API_KEY_VAR}"
if [ -z "$API_KEY" ]; then
    echo -e "${RED}ERROR: $API_KEY_VAR not set in .env${NC}"
    echo "Please add: $API_KEY_VAR=your_api_key_here"
    exit 1
fi

echo -e "${GREEN}âœ“ Environment variables loaded${NC}"
echo -e "${GREEN}âœ“ Network configuration validated${NC}"
echo ""

# Get user confirmation
echo -e "${YELLOW}This will deploy to $DISPLAY_NAME and verify on the respective block explorer${NC}"
echo "Network: $DISPLAY_NAME"
echo "Chain ID: $CHAIN_ID"
echo "RPC URL: $(echo "$RPC_URL" | cut -c1-40)..."
echo "API Key: $(echo "$API_KEY" | cut -c1-8)..."
echo ""
printf "Continue? (y/N): "
read -r REPLY
if [ "$REPLY" != "y" ] && [ "$REPLY" != "Y" ]; then
    echo "Deployment cancelled"
    exit 0
fi

echo ""
echo -e "${GREEN}Starting deployment to $DISPLAY_NAME...${NC}"
echo ""

# Deploy with verification
echo -e "${YELLOW}Deploying complete system with block explorer verification...${NC}"
forge script script/PortfolioRebalancer.s.sol:DeployPortfolioRebalancer \
    --rpc-url "$RPC_URL" \
    --private-key "$PRIVATE_KEY" \
    --broadcast \
    --verify \
    -vvv

echo ""
echo -e "${GREEN}=== Deployment Complete! ===${NC}"
echo ""
echo -e "${GREEN}Next steps:${NC}"
case $NETWORK in
    sepolia)
        echo "1. Check Etherscan Sepolia for verified contracts"
        echo "2. Review deployed addresses in addressBook/11155111.json"
        ;;
    mainnet)
        echo "1. Check Etherscan for verified contracts"
        echo "2. Review deployed addresses in addressBook/1.json"
        ;;
    base)
        echo "1. Check Basescan for verified contracts"
        echo "2. Review deployed addresses in addressBook/8453.json"
        ;;
    baseSepolia)
        echo "1. Check Basescan Sepolia for verified contracts"
        echo "2. Review deployed addresses in addressBook/84532.json"
        ;;
esac
echo "3. Test vault creation using the factory"
echo ""
echo -e "${GREEN}Verification status:${NC}"
echo "- Implementation contracts should be verified automatically"
echo "- Proxy contracts will show 'More Options' -> 'Is this a proxy?' on block explorer"
echo "- If verification failed, use manual commands from deployment output"
echo ""
echo -e "${GREEN}Done! ðŸš€${NC}" 